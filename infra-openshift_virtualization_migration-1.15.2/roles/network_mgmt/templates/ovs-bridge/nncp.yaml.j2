apiVersion: nmstate.io/v1
kind: NodeNetworkConfigurationPolicy
metadata:
  name: {{ vswitch.name | infra.openshift_virtualization_migration.rfc1123(network_mgmt_nncp_name_prefix) }}
  annotations: 
    infra.openshift-virtualization-migration/source-vswitch: "{{ vswitch.name }}"
    infra.openshift-virtualization-migration/provider-hostname: {{ network_mgmt_vcenter_hostname }}
    infra.openshift-virtualization-migration/provider-type: vmware 
spec:
  desiredState:
    ovn:
      bridge-mappings:
       - bridge: {{ ("br-ex" if network_mgmt_use_default_ovn_bridge else (vswitch.name | infra.openshift_virtualization_migration.rfc1123(network_mgmt_nncp_name_prefix))[:15]) }}
         localnet: localnet-default-vlan
         state: present
{% for port_group in portgroups_to_migrate %}
{% if (port_group['switch'] == vswitch.name)  and (port_group['uplinks'] > 0) and (not port_group['vlan']['trunk']) %}
       - bridge: {{ ("br-ex" if network_mgmt_use_default_ovn_bridge else (vswitch.name | infra.openshift_virtualization_migration.rfc1123(network_mgmt_nncp_name_prefix))[:15]) }}
         localnet: localnet-vlan-{{ port_group['vlan']['vlan_id'] }}
         state: present
{% endif %}
{% endfor %}
{% if not network_mgmt_use_default_ovn_bridge %}
    interfaces:
{% if not network_mgmt_port_is_existing_bond %}
      - ipv4:
          enabled: false
        ipv6:
          enabled: false
        link-aggregation:
          mode: {{ network_mgmt_openshift_network_bond_mode }}
          port: {{ network_mgmt_openshift_node_network_ports }}
        mtu: {{ vswitch.mtu }}
        name: {{ (vswitch.name | infra.openshift_virtualization_migration.rfc1123(network_mgmt_nncp_name_prefix))[:12] }}-up
        state: up
        type: bond
{% endif %}
      - bridge:
          options:
            stp: true
            port:
{% if not network_mgmt_port_is_existing_bond %}
            - name: {{ (vswitch.name | infra.openshift_virtualization_migration.rfc1123(network_mgmt_nncp_name_prefix))[:12] }}-up
{% else %}
            - name: {{ network_mgmt_openshift_node_network_ports[0] }}
{% endif %}
        ipv4:
          enabled: false
        ipv6:
          enabled: false
        name: {{ (vswitch.name | infra.openshift_virtualization_migration.rfc1123(network_mgmt_nncp_name_prefix))[:15] }}
        state: up
        type: ovs-bridge
{% for port in network_mgmt_openshift_node_network_ports %}
      - ipv4:  
          enabled: false
        ipv6:
          enabled: false
        mtu: {{ vswitch.mtu }}
        name: {{ port }}
        state: up
        type: ethernet
{% endfor %}
{% endif %}
  maxUnavailable: {{ network_mgmt_nncp_max_unavailable }}
  nodeSelector:
    {{ network_mgmt_nncp_nodeselector }}

